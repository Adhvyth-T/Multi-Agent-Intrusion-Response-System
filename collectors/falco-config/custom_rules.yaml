# falco-config/custom_rules.yaml
# Custom rules for IR system (FIXED for Falco)

# Define macros we need (or rely on default falco_rules.yaml)
# The spawned_process macro is in falco_rules.yaml, but let's define it here too
- macro: spawned_process
  condition: (evt.type in (execve, execveat) and evt.dir=<)

- macro: container
  condition: (container.id != host)

# Rule 1: Cryptominer Detection
- rule: Cryptominer Detected
  desc: Detect cryptocurrency mining processes
  condition: >
    spawned_process and container and (
      proc.name in (xmrig, minerd, cpuminer, ethminer, ccminer) or
      proc.cmdline contains "stratum+tcp" or
      proc.cmdline contains "pool.minexmr" or
      proc.cmdline contains "cryptonight" or
      proc.cmdline contains "monero"
    )
  output: >
    Cryptominer process detected 
    (user=%user.name command=%proc.cmdline container=%container.name 
    image=%container.image.repository)
  priority: CRITICAL
  tags: [malware, cryptominer, T1496]

# Rule 2: Reverse Shell Detection
- rule: Reverse Shell Connection
  desc: Detect reverse shell attempts
  condition: >
    spawned_process and container and (
      (proc.name in (bash, sh, zsh, dash) and (
        proc.cmdline contains "/dev/tcp" or
        proc.cmdline contains "bash -i" or
        proc.cmdline contains "sh -i"
      )) or
      (proc.name in (nc, ncat, netcat) and (
        proc.cmdline contains "-e" or
        proc.cmdline contains "-c"
      ))
    )
  output: >
    Reverse shell detected 
    (user=%user.name command=%proc.cmdline container=%container.name 
    image=%container.image.repository)
  priority: CRITICAL
  tags: [shell, backdoor, T1059]

# Rule 3: High CPU Usage Process
- rule: High CPU Usage Process
  desc: Detect processes consuming excessive CPU
  condition: >
    spawned_process and container and (
      proc.cmdline contains "while true" or
      proc.cmdline contains ":(){ :|:& };:" or
      proc.name in (stress, stress-ng)
    )
  output: >
    High CPU usage process detected 
    (user=%user.name command=%proc.cmdline container=%container.name)
  priority: WARNING
  tags: [resource, dos, T1496]

# Rule 4: Container Shell Spawn
- rule: Container Shell Spawn
  desc: Detect interactive shell in container
  condition: >
    spawned_process and 
    container and
    proc.name in (bash, sh, zsh) and
    proc.tty != 0
  output: >
    Shell spawned in container 
    (user=%user.name shell=%proc.name container=%container.name 
    tty=%proc.tty)
  priority: WARNING
  tags: [shell, container]

# Rule 5: Port Scanning Activity
- rule: Port Scanning Activity
  desc: Detect port scanning tools
  condition: >
    spawned_process and container and (
      proc.name in (nmap, masscan, zmap, unicornscan) or
      proc.cmdline contains "for port in" or
      proc.cmdline contains "nc -zv"
    )
  output: >
    Port scanning detected 
    (user=%user.name command=%proc.cmdline container=%container.name)
  priority: WARNING
  tags: [network, recon, T1046]